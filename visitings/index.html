<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HTV795ZMCP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HTV795ZMCP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Visitings - 3D Globe</title>
    <meta name="author" content="Peng, Andy">
    <meta name="description" content="Interactive 3D Globe of Places I've Visited">
    <meta name="keywords" content="Visitings, Travel, 3D Globe, Interactive Map">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/main.css">

    <style>
        :root {
            --primary-color: #A8DAF9;
            --secondary-color: #6BB6FF;
            --accent-color: #FFD700;
            --bg-dark: #0a0e27;
            --bg-medium: #1a1f3a;
            --text-light: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 50%, var(--bg-dark) 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 30px 20px 20px;
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(168, 218, 249, 0.2);
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--primary-color);
            margin-top: 10px;
            opacity: 0.8;
        }

        .view-switcher {
            position: absolute;
            top: 30px;
            left: 20px;
            z-index: 200;
        }

        .view-switcher a {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(10, 14, 39, 0.9);
            border: 1px solid rgba(168, 218, 249, 0.3);
            border-radius: 8px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .view-switcher a:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--bg-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(168, 218, 249, 0.4);
        }

        #globeViz {
            width: 100%;
            height: calc(100vh - 200px);
            min-height: 600px;
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 14, 39, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(168, 218, 249, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            max-width: 180px;
        }

        .controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 5px;
            color: var(--bg-dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(168, 218, 249, 0.4);
        }

        .controls button i {
            margin-right: 5px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 14, 39, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(168, 218, 249, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .stats {
            text-align: center;
            padding: 20px;
            background: rgba(10, 14, 39, 0.6);
            border-top: 1px solid rgba(168, 218, 249, 0.2);
        }

        .stat-item {
            display: inline-block;
            margin: 0 30px;
            padding: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(168, 218, 249, 0.8);
            margin-top: 5px;
        }

        footer {
            position: relative;
            text-align: center;
            padding: 20px;
            background: rgba(10, 14, 39, 0.8);
            border-top: 1px solid rgba(168, 218, 249, 0.2);
            color: rgba(168, 218, 249, 0.8);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: var(--primary-color);
            z-index: 10;
        }

        .spinner {
            border: 3px solid rgba(168, 218, 249, 0.3);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .view-switcher {
                position: relative;
                top: 0;
                left: 0;
                text-align: center;
                margin-top: 10px;
            }

            .controls {
                top: 10px;
                right: 10px;
                padding: 10px;
                max-width: 150px;
            }

            .controls button {
                font-size: 0.75rem;
                padding: 8px 10px;
            }

            .legend {
                bottom: 10px;
                left: 10px;
                font-size: 0.8rem;
            }

            .stat-item {
                margin: 0 15px;
            }

            .stat-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="view-switcher">
            <a href="../visitings.html"><i class="fas fa-map"></i> View 2D Map</a>
        </div>
        <h1>My Travels Around the World</h1>
        <p class="subtitle">Interactive 3D Globe Visualization</p>
    </div>

    <div id="globeViz">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            Loading Globe...
        </div>

        <div class="controls">
            <button onclick="resetView()"><i class="fas fa-sync-alt"></i> Reset View</button>
            <button onclick="toggleRotation()"><i class="fas fa-play"></i> <span id="rotateText">Auto Rotate</span></button>
            <button onclick="toggleArcs()"><i class="fas fa-route"></i> <span id="arcsText">Show Routes</span></button>
            <button onclick="toggleRings()"><i class="fas fa-circle"></i> <span id="ringsText">Show Rings</span></button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(168, 218, 249, 0.8);"></div>
                <span>Cities Visited</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(107, 182, 255, 0.5);"></div>
                <span>Countries Visited</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(255, 215, 0, 0.6);"></div>
                <span>Travel Routes</span>
            </div>
        </div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-number" id="countriesCount">0</div>
            <div class="stat-label">Countries Visited</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="citiesCount">0</div>
            <div class="stat-label">Cities & Places</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="arcCount">0</div>
            <div class="stat-label">Routes</div>
        </div>
    </div>

    <footer>
        <div class="container mt-0">
            Â© Copyright 2025 Andy Peng
        </div>
    </footer>

    <!-- Globe.GL Library -->
    <script src="//unpkg.com/globe.gl"></script>

    <!-- Data Files -->
    <script src="data/countries.js"></script>
    <script src="data/cities.js"></script>

    <script>
        // Initialize globe
        const globe = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#A8DAF9')
            .atmosphereAltitude(0.15);

        // Set initial view
        globe.pointOfView({ lat: 39.9, lng: 116.4, altitude: 2.5 });

        // Prepare countries data for polygons
        const visitedCountries = Object.keys(COUNTRIES);

        // Hide loading once globe starts rendering
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
        }, 2000);

        // Fetch countries GeoJSON for highlighting
        fetch('//unpkg.com/world-atlas/countries-50m.json')
            .then(res => res.json())
            .then(worldData => {
                const countries = topojson.feature(worldData, worldData.objects.countries);

                // Filter to only visited countries (using ISO numeric codes)
                const isoCodeMap = {
                    'USA': '840',
                    'CHN': '156',
                    'NLD': '528',
                    'BEL': '056'
                };

                const visitedPolygons = countries.features.filter(d => {
                    return visitedCountries.some(code => isoCodeMap[code] === d.id);
                });

                globe.polygonsData(visitedPolygons)
                    .polygonAltitude(0.01)
                    .polygonCapColor(() => 'rgba(107, 182, 255, 0.5)')
                    .polygonSideColor(() => 'rgba(107, 182, 255, 0.3)')
                    .polygonStrokeColor(() => '#A8DAF9')
                    .polygonLabel(({ properties: d }) => `
                        <div style="background: rgba(10, 14, 39, 0.95); padding: 8px 12px; border-radius: 6px; border: 1px solid #A8DAF9;">
                            <b>${d.name}</b>
                        </div>
                    `);
            });

        // Add cities as points
        const citiesData = CITIES.map(city => ({
            lat: city.latitude,
            lng: city.longitude,
            name: city.name,
            date: city.date || 'Multiple visits',
            radius: city.radius / 3
        }));

        globe.pointsData(citiesData)
            .pointAltitude(0.01)
            .pointRadius('radius')
            .pointColor(() => 'rgba(168, 218, 249, 0.9)')
            .pointLabel(d => `
                <div style="background: rgba(10, 14, 39, 0.95); padding: 8px 12px; border-radius: 6px; border: 1px solid #A8DAF9;">
                    <b>${d.name}</b><br/>
                    ${d.date ? `<small>${d.date}</small>` : ''}
                </div>
            `);

        // Create arcs between cities (chronological travel routes)
        const citiesWithDates = CITIES.filter(c => c.date && c.date !== '');
        citiesWithDates.sort((a, b) => {
            if (a.date < b.date) return -1;
            if (a.date > b.date) return 1;
            return 0;
        });

        const arcsData = [];
        for (let i = 0; i < citiesWithDates.length - 1; i++) {
            arcsData.push({
                startLat: citiesWithDates[i].latitude,
                startLng: citiesWithDates[i].longitude,
                endLat: citiesWithDates[i + 1].latitude,
                endLng: citiesWithDates[i + 1].longitude,
                color: 'rgba(255, 215, 0, 0.6)'
            });
        }

        document.getElementById('arcCount').textContent = arcsData.length;

        let arcsVisible = false;
        let ringsVisible = false;

        function toggleArcs() {
            arcsVisible = !arcsVisible;
            const button = document.getElementById('arcsText');

            if (arcsVisible) {
                button.innerHTML = 'Hide Routes';
                globe.arcsData(arcsData)
                    .arcColor('color')
                    .arcDashLength(0.4)
                    .arcDashGap(0.2)
                    .arcDashAnimateTime(2000)
                    .arcStroke(0.5);
            } else {
                button.innerHTML = 'Show Routes';
                globe.arcsData([]);
            }
        }

        function toggleRings() {
            ringsVisible = !ringsVisible;
            const button = document.getElementById('ringsText');

            if (ringsVisible) {
                button.innerHTML = 'Hide Rings';
                globe.ringsData(citiesData)
                    .ringColor(() => 'rgba(168, 218, 249, 0.5)')
                    .ringMaxRadius(4)
                    .ringPropagationSpeed(2)
                    .ringRepeatPeriod(1500);
            } else {
                button.innerHTML = 'Show Rings';
                globe.ringsData([]);
            }
        }

        // Update stats
        document.getElementById('countriesCount').textContent = visitedCountries.length;
        document.getElementById('citiesCount').textContent = CITIES.length;

        // Auto-rotation control
        let autoRotate = false;

        function toggleRotation() {
            autoRotate = !autoRotate;
            const button = document.getElementById('rotateText');

            if (autoRotate) {
                button.innerHTML = 'Stop Rotate';
                startRotation();
            } else {
                button.innerHTML = 'Auto Rotate';
                stopRotation();
            }
        }

        function startRotation() {
            globe.controls().autoRotate = true;
            globe.controls().autoRotateSpeed = 0.5;
        }

        function stopRotation() {
            globe.controls().autoRotate = false;
        }

        function resetView() {
            globe.pointOfView({ lat: 39.9, lng: 116.4, altitude: 2.5 }, 1000);
            stopRotation();
            autoRotate = false;
            document.getElementById('rotateText').innerHTML = 'Auto Rotate';
        }

        // Responsive sizing
        window.addEventListener('resize', () => {
            globe.width(document.getElementById('globeViz').offsetWidth);
            globe.height(document.getElementById('globeViz').offsetHeight);
        });

        // Smooth entry animation
        setTimeout(() => {
            globe.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 3000);
        }, 1000);

        // Show a random city every few seconds during auto-rotate
        let cityTourInterval;
        function startCityTour() {
            if (cityTourInterval) clearInterval(cityTourInterval);

            cityTourInterval = setInterval(() => {
                if (autoRotate) {
                    const randomCity = citiesData[Math.floor(Math.random() * citiesData.length)];
                    globe.pointOfView({
                        lat: randomCity.lat,
                        lng: randomCity.lng,
                        altitude: 1.5
                    }, 2000);
                }
            }, 8000);
        }
    </script>

    <!-- TopojSON for country boundaries -->
    <script src="//unpkg.com/topojson-client"></script>
</body>
</html>
